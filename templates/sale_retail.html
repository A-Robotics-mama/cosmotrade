<!-- templates/sale_retail.html -->

{% extends "base.html" %}
{% load static %}

{% block title %}Retail Sale - Cosmotrade CRM{% endblock %}

{% block content %}
<div class="container mt-4">

  <div class="d-flex justify-content-between align-items-center mb-4">
    <h2 class="mb-0">Retail Sale</h2>
    <a href="{% url 'sales:sale_retail' %}" class="btn btn-success">
      <i class="fas fa-plus me-1"></i> New Retail Sale
    </a>
  </div>

  {% if error %}
    <div class="alert alert-danger" role="alert">{{ error }}</div>
  {% endif %}
  {% if success %}
    <div class="alert alert-success" role="alert">{{ success }}</div>
  {% endif %}

  <form method="post" id="sale-form" action="{% url 'sales:sale_retail' %}" class="card shadow-sm p-4">
  {% csrf_token %}
  <input type="hidden" name="payment_code" value="0">
  <input type="hidden" name="sale_type" value="retail">
  <input type="hidden" name="import_id" id="import_id">
  <input type="hidden" name="invoice" id="invoice">

  <div class="row g-4">
    <!-- Customer / Product -->
    <div class="col-md-6">
      <label for="customer_input" class="form-label">Customer:</label>
      <input type="text" id="customer_input" class="form-control" placeholder="Search for customer..." value="{{ customer }}">
      <input type="hidden" name="customer_id" id="customer_id" value="{{ customer_id }}">
    </div>
    <div class="col-md-6">
      <label for="product_input" class="form-label">Product:</label>
      <input type="text" id="product_input" class="form-control" placeholder="Search for product...">
      <input type="hidden" name="product_id" id="product_id" value="{{ product_id }}">
    </div>

    <!-- Invoice / Qty -->
    <div class="col-md-6">
      <label for="invoice_input" class="form-label">Invoice:</label>
      <input type="text" id="invoice_input" class="form-control" placeholder="Select invoice...">
    </div>
    <div class="col-md-6">
      <label for="qty" class="form-label">Quantity:</label>
      <input type="number" name="qty" id="qty" class="form-control" value="{{ qty|default:'1' }}">
    </div>

    <!-- Stock Price / Trade Margin -->
    <div class="col-md-6">
      <label for="sell_price" class="form-label">Stock Price (€):</label>
      <input type="number" step="0.01" name="sell_price" id="sell_price" class="form-control" readonly value="{{ sell_price }}">
    </div>
    <div class="col-md-6">
      <label for="trade_margin" class="form-label">Trade Margin Multiplier:</label>
      <input type="number" step="0.5" name="trade_margin" id="trade_margin" class="form-control" value="1.0">
    </div>

    <!-- Crude / Discount -->
    <div class="col-md-6">
      <label for="crude_price" class="form-label">Crude Price (€):</label>
      <input type="number" step="0.01" id="crude_price" name="crude_price" class="form-control" readonly>
    </div>
    <div class="col-md-6">
      <label for="trade_discount" class="form-label">Trade Discount (%):</label>
      <select name="trade_discount" id="trade_discount" class="form-control">
        <option value="0">0%</option>
        <option value="5" selected>5%</option>
        <option value="10">10%</option>
        <option value="15">15%</option>
        <option value="20">20%</option>
      </select>
    </div>

    <!-- Discount / Commission -->
    <div class="col-md-6">
      <label for="discount_amount" class="form-label">Discount Amount (€):</label>
      <input type="number" step="0.01" id="discount_amount" name="discount_amount" class="form-control" readonly>
    </div>
    <div class="col-md-6">
      <label for="agent_commission_rate" class="form-label">Agent Commission Rate (%):</label>
      <select name="agent_commission_rate" id="agent_commission_rate" class="form-control">
        <option value="0">0%</option>
        <option value="5">5%</option>
        <option value="10">10%</option>
        <option value="15">15%</option>
        <option value="20">20%</option>
      </select>
    </div>

    <!-- Commission / Final w/o VAT -->
    <div class="col-md-6">
      <label for="commission_amount" class="form-label">Commission Amount (€):</label>
      <input type="number" step="0.01" id="commission_amount" name="commission_amount" class="form-control" readonly>
    </div>
    <div class="col-md-6">
      <label for="final_sell_price_without_vat" class="form-label">Final Sale Price w/o VAT (€):</label>
      <input type="number" step="0.01" name="final_sell_price_without_vat" id="final_sell_price_without_vat" class="form-control" readonly value="{{ final_sell_price }}">
    </div>

    <!-- VAT / VAT Amount -->
    <div class="col-md-6">
      <label for="vat_rate" class="form-label">VAT Rate (%):</label>
      <select name="vat_rate" id="vat_rate" class="form-control">
        <option value="0" selected>0% (Export)</option>
        <option value="5">5% (Food Supplements)</option>
        <option value="19">19% (Standard)</option>
      </select>
    </div>
    <div class="col-md-6">
      <label for="vat_amount" class="form-label">VAT Amount (€):</label>
      <input type="number" step="0.01" id="vat_amount" name="vat_amount" class="form-control" readonly value="{{ sale_vat }}">
    </div>

    <!-- Customer Price / Profit -->
    <div class="col-md-6">
      <label for="customer_price" class="form-label">Customer Price (€):</label>
      <input type="number" step="0.01" name="customer_price" id="customer_price" class="form-control" readonly value="{{ total_with_vat }}">
    </div>
    <div class="col-md-6">
      <label for="profit" class="form-label">Profit (€):</label>
      <input type="number" step="0.01" name="profit" id="profit" class="form-control" readonly>
    </div>
  </div>

  <div class="mt-4 d-flex justify-content-start">
    <button type="submit" class="btn btn-primary">
      <i class="fas fa-check-circle me-1"></i> Complete Sale
    </button>
  </div>
</form>


</div>
{% endblock %}

{% block extra_scripts %}
<script>
  window.urls = {
    customerAutocomplete: "{% url 'customers:customer_autocomplete' %}",
    productAutocomplete: "{% url 'products:product_autocomplete' %}",
    stockImportsForProduct: "{% url 'stock:stock_imports_for_product' %}",
    getStockPrice: "{% url 'sales:get_stock_price' %}",
    {% if quotation %} completeQuotationBase: "{% url 'sales:complete_quotation' '' %}" {% endif %}
  };
</script>
<script type="module" src="{% static 'js/main.js' %}?v=1"></script>
{% endblock %}
